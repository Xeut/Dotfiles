#!/usr/bin/env bash

# --- Konfiguration & Sicherheit ---
# -e: Beendet bei Fehlern
# -u: Beendet bei nicht definierten Variablen
# -o pipefail: Erkennt Fehler in Pipelines
set -euo pipefail

# Farben für die Ausgabe
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Verzeichnisse definieren
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
TARGET_DIR="$HOME"
BACKUP_DIR="$HOME/dotfiles_backup_$(date +%Y%m%d_%H%M%S)"

# Liste der Dateien/Ordner, die ignoriert werden sollen
EXCLUDE_LIST=(".git" ".gitignore" "README.md" "$(basename "$0")" ".DS_Store")

# --- Funktionen ---

log_info()    { echo -e "${GREEN}[INFO]${NC} $1"; }
log_warn()    { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error()   { echo -e "${RED}[ERROR]${NC} $1" >&2; }

# Prüfen, ob ein Element in der Ausschlussliste ist
is_excluded() {
    local item="$1"
    for ex in "${EXCLUDE_LIST[@]}"; do
        [[ "$item" == "$ex" ]] && return 0
    done
    return 1
}

setup_links() {
    log_info "Starte Symlink-Erstellung aus: $SCRIPT_DIR"
    
    # Sicherstellen, dass wir im richtigen Verzeichnis arbeiten
    cd "$SCRIPT_DIR"

    # Über alle Dateien im Script-Ordner iterieren (auch versteckte)
    # . und .. werden durch das Globbing/Prüfung ausgeschlossen
    for source_path in .* *; do
        # Basis-Checks
        [[ "$source_path" == "." || "$source_path" == ".." ]] && continue
        is_excluded "$source_path" && continue
        [[ ! -e "$source_path" ]] && continue

        local target_path="$TARGET_DIR/$source_path"
        local abs_source_path="$SCRIPT_DIR/$source_path"

        # 1. Fall: Symlink existiert bereits und zeigt auf das richtige Ziel
        if [[ -L "$target_path" && "$(readlink -f "$target_path")" == "$abs_source_path" ]]; then
            log_info "OK: $source_path ist bereits korrekt verlinkt."
            continue
        fi

        # 2. Fall: Ziel existiert (als Datei, Verzeichnis oder falscher Symlink) -> Backup
        if [[ -e "$target_path" || -L "$target_path" ]]; then
            log_warn "Backup: $target_path existiert bereits. Verschiebe nach $BACKUP_DIR"
            mkdir -p "$BACKUP_DIR"
            mv "$target_path" "$BACKUP_DIR/"
        fi

        # 3. Fall: Symlink erstellen
        log_info "Verlinke: $source_path -> $target_path"
        ln -s "$abs_source_path" "$target_path"
    done
}

# --- Ausführung ---

main() {
    # Kurze Bestätigung
    echo "Dieses Skript wird Symlinks in $TARGET_DIR erstellen."
    echo "Originale werden in $BACKUP_DIR gesichert."
    read -p "Fortfahren? (j/n) " -n 1 -r
    echo
    [[ ! $REPLY =~ ^[Jj]$ ]] && { log_warn "Abgebrochen."; exit 0; }

    setup_links
    
    log_info "Fertig! Alle Dotfiles wurden verarbeitet."
    [[ -d "$BACKUP_DIR" ]] && log_info "Backups findest du in: $BACKUP_DIR"
}

main "$@"
